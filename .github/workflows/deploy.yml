name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.EC2_SSH_KEY }}
          known_hosts: ${{ secrets.EC2_HOST }}
          config: |
            Host ${{ secrets.EC2_HOST }}
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null

      - name: Deploy Frontend
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸ“ Navigating to project directory..."
            cd ~/front-end/New-Linkedin-FE || {
              echo "âŒ Error: Directory not found!";
              ls -la ~/;
              exit 1;
            }

            echo "ðŸ“¥ Pulling latest code from main branch..."
            git pull origin main

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            echo "ðŸ—ï¸ Building frontend..."
            npm run build

            echo "ðŸ§¹ Clearing old Nginx files..."
            sudo rm -rf /var/www/html/*

            echo "ðŸ“ Copying new build..."
            sudo cp -r dist/* /var/www/html/

            echo "ðŸ” Restarting Nginx..."
            sudo systemctl restart nginx

            echo "âœ… Deployment complete!"
          EOF
